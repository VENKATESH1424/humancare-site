<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Human - OCR Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow-md w-full max-w-3xl">
    <h2 class="text-2xl font-bold mb-6 text-center">Upload Medical Report (OCR)</h2>

    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-2">Human Number</label>
      <input type="text" id="humanNumber" placeholder="HN-KA-XXXX" class="w-full p-2 border rounded">
    </div>

    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-2">Upload Report (Image or PDF)</label>
      <input type="file" id="reportFile" accept="image/*,.pdf" class="w-full">
    </div>

    <button onclick="processOCR()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Extract Text via OCR</button>

    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-2">Extracted Text:</h3>
      <pre id="ocrOutput" class="bg-gray-100 p-4 border rounded max-h-96 overflow-y-auto"></pre>
    </div>
  </div>

  <script>
    const VISION_API_KEY = '88b9850db6a3fdf31cca77371adccb243b26a331'; // Replace with your key

    async function processOCR() {
      const fileInput = document.getElementById('reportFile');
      const output = document.getElementById('ocrOutput');
      const humanNumber = document.getElementById('humanNumber').value.trim();

      if (!humanNumber || !fileInput.files.length) {
        alert('Please enter Human Number and select a file.');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async () => {
        const base64Data = reader.result.split(',')[1];

        const requestBody = {
          requests: [
            {
              image: { content: base64Data },
              features: [{ type: 'TEXT_DETECTION' }]
            }
          ]
        };

        try {
          const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${VISION_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });

          const result = await res.json();
          const text = result.responses[0]?.fullTextAnnotation?.text || 'No text found.';
          output.textContent = text;

          // TODO: Apply parsing rules and prepare for Firebase upload
        } catch (error) {
          console.error('OCR error:', error);
          alert('Failed to extract text. Check console for details.');
        }
      };

      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
