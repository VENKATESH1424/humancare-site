<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTP Verification - Human Care</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="register-container">
    <h1>OTP Verification</h1>

    <div id="phone-display"></div>

    <div id="recaptcha-container"></div>

    <input type="text" id="otpInput" placeholder="Enter OTP" />
    <button onclick="verifyOTP()">Verify OTP</button>

    <div id="password-section" style="display: none;">
      <input type="password" id="newPassword" placeholder="Create Password" />
      <input type="password" id="confirmPassword" placeholder="Confirm Password" />
      <button onclick="finishRegistration()">Finish Registration</button>
    </div>
  </div>

  <script>
    // ✅ Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBQZpYn-nXx3ydA95lCH7eduC5cUqE5O6w",
      authDomain: "humancare-web1.firebaseapp.com",
      projectId: "humancare-web1",
      storageBucket: "humancare-web1.firebasestorage.app",
      messagingSenderId: "986623782553",
      appId: "1:986623782553:web:fd3cd6c363bb8390be1208",
      databaseURL: "https://humancare-web1-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const database = firebase.database();

    // ✅ Get phone number from session storage
    const phone = sessionStorage.getItem("phoneNumber");
    document.getElementById("phone-display").innerText = "Sending OTP to: " + phone;

    // ✅ Render reCAPTCHA and send OTP
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      size: 'invisible'
    });

    auth.signInWithPhoneNumber(phone, window.recaptchaVerifier)
      .then(confirmationResult => {
        window.confirmationResult = confirmationResult;
      }).catch(error => {
        alert("Error sending OTP: " + error.message);
      });

    // ✅ Verify OTP
    function verifyOTP() {
      const otp = document.getElementById("otpInput").value;
      confirmationResult.confirm(otp).then(result => {
        document.getElementById("password-section").style.display = "block";
      }).catch(error => {
        alert("Incorrect OTP: " + error.message);
      });
    }

    // ✅ Generate Human Number
    function generateHumanNumber(stateCode = "KA") {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let randomCode = "";
      for (let i = 0; i < 6; i++) {
        randomCode += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return `HN-${stateCode}-${randomCode}`;
    }

    // ✅ Store data in Firebase
    function finishRegistration() {
      const pwd = document.getElementById("newPassword").value;
      const cpwd = document.getElementById("confirmPassword").value;
      if (pwd !== cpwd) {
        alert("Passwords do not match!");
        return;
      }

      // Get stored details from form submission (stored earlier)
      const fullData = {
        fullName: sessionStorage.getItem("fullName"),
        dob: sessionStorage.getItem("dob"),
        gender: sessionStorage.getItem("gender"),
        phoneNumber: sessionStorage.getItem("phoneNumber"),
        emergencyContact: sessionStorage.getItem("emergencyContact"),
        email: sessionStorage.getItem("email"),
        address: sessionStorage.getItem("address"),
        bloodGroup: sessionStorage.getItem("bloodGroup"),
        caste: sessionStorage.getItem("caste"),
        education: sessionStorage.getItem("education"),
        motherTongue: sessionStorage.getItem("motherTongue"),
        occupation: sessionStorage.getItem("occupation"),
        aadhaar: sessionStorage.getItem("aadhaar"),
        income: sessionStorage.getItem("income"),
        bpl: sessionStorage.getItem("bpl"),
        abha: sessionStorage.getItem("abha"),
        esi: sessionStorage.getItem("esi"),
        vajpayee: sessionStorage.getItem("vajpayee"),
        password: pwd,
      };

      const humanNumber = generateHumanNumber();

      // Save to Firebase
      database.ref('humans/' + humanNumber).set({
        ...fullData,
        humanNumber: humanNumber
      }).then(() => {
        alert("Registration successful! Your Human Number is: " + humanNumber);
        sessionStorage.clear();
        window.location.href = "human-login.html";
      }).catch(err => {
        alert("Error saving data: " + err.message);
      });
    }
  </script>
</body>
</html>
