<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verify OTP | Human Registration</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2>Verify Your Phone Number</h2>
    
    <div id="otp-section">
      <input type="text" id="otp" placeholder="Enter OTP" />
      <button onclick="verifyOTP()">Verify OTP</button>
    </div>

    <div id="password-section" style="display:none;">
      <input type="password" id="password" placeholder="Create Password" />
      <input type="password" id="confirmPassword" placeholder="Confirm Password" />
      <button onclick="completeRegistration()">Complete Registration</button>
    </div>

    <div id="recaptcha-container"></div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBQZpYn-nXx3ydA95lCH7eduC5cUqE5O6w",
      authDomain: "humancare-web1.firebaseapp.com",
      projectId: "humancare-web1",
      databaseURL: "https://humancare-web1-default-rtdb.firebaseio.com/",
      appId: "1:986623782553:web:fd3cd6c363bb8390be1208"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // Retrieve phone number from session and trigger OTP
    const phoneNumber = sessionStorage.getItem('phoneNumber');
    const stateCode = sessionStorage.getItem('stateCode'); // Set this during registration
    const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');

    auth.signInWithPhoneNumber(phoneNumber, appVerifier)
      .then(confirmationResult => {
        window.confirmationResult = confirmationResult;
      }).catch(error => {
        alert("Error sending OTP: " + error.message);
      });

    function verifyOTP() {
      const code = document.getElementById("otp").value;
      confirmationResult.confirm(code).then(result => {
        document.getElementById("otp-section").style.display = "none";
        document.getElementById("password-section").style.display = "block";
      }).catch(error => {
        alert("Incorrect OTP");
      });
    }

    function generateHumanNumber(stateCode) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let random = '';
      for (let i = 0; i < 6; i++) {
        random += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return `HN-${stateCode}-${random}`;
    }

    function completeRegistration() {
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      if (password !== confirmPassword) {
        alert("Passwords do not match");
        return;
      }

      const humanNumber = generateHumanNumber(stateCode || 'KA');
      const userData = JSON.parse(sessionStorage.getItem('registrationData'));
      userData.humanNumber = humanNumber;
      userData.password = password;
      userData.phone = phoneNumber;

      // Store in Firebase Realtime DB
      db.ref('humans/' + humanNumber).set(userData).then(() => {
        alert("Registration successful! Your Human Number is: " + humanNumber);
        window.location.href = "human-login.html";
      }).catch(error => {
        alert("Error saving data: " + error.message);
      });
    }
  </script>
</body>
</html>
